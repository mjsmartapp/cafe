<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapple's Cafe - Employees</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        :root {
            --primary-color: #6a3d11;
            --secondary-color: #d8c29d;
            --accent-color: #a44a3f;
            --bg-color: #f7f2eb;
            --card-bg: #fff;
            --text-dark: #333;
            --text-light: #f4f4f4;
            --success-color: #4CAF50;
            --danger-color: #d32f2f;
            --info-color: #2196F3;
            --border-radius: 10px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --sidebar-width: 250px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-dark);
            display: flex; 
            min-height: 100vh;
        }

        #sidebar { 
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 20px 10px;
            box-shadow: var(--box-shadow);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        #sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--secondary-color);
            font-size: 1.5em;
        }

        #sidebar ul {
            list-style: none;
            padding: 0;
        }

        #sidebar ul li {
            margin-bottom: 10px;
        }

        #sidebar ul li a, #sidebar ul li button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            color: var(--text-light);
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
            cursor: pointer;
            border: none;
            background: transparent;
            text-align: left;
            font-size: 1em;
        }

        #sidebar ul li a.active, #sidebar ul li a:hover, #sidebar ul li button:hover {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        /* New style for sidebar action buttons */
        #sidebar .sidebar-action-button {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            font-weight: 600;
            margin-top: 5px;
            border: 1px solid var(--secondary-color);
            text-align: center;
        }

        #sidebar .sidebar-action-button.btn-danger {
            background-color: var(--danger-color);
            color: var(--text-light);
            border-color: var(--danger-color);
        }

        #sidebar .sidebar-action-button.btn-danger:hover {
            background-color: #c0392b;
            color: var(--text-light);
        }

        #sidebar .sidebar-action-button:hover {
            background-color: var(--primary-color);
            color: var(--secondary-color);
        }

        .container {
            flex-grow: 1;
            padding: 20px;
            transition: margin-left 0.3s;
            padding-bottom: 50px; 
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--secondary-color);
            background-color: var(--card-bg); 
            padding: 15px 20px;
            margin: -20px -20px 20px -20px; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); 
            position: sticky; 
            top: 0;
            z-index: 50;
        }
        
        /* ADDED: Mobile Nav Toggle Button Styling (Hidden by default) */
        .mobile-nav-toggle {
            display: none; 
            padding: 8px 12px;
            margin-right: 15px;
            background: var(--primary-color);
            color: var(--text-light);
            border: none;
            border-radius: 5px;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 1001; 
            line-height: 1;
        }
        
        /* ADDED: Sidebar Backdrop for Drawer View */
        .sidebar-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        .sidebar-backdrop.visible {
            display: block;
        }
        /* End ADDED Drawer Styling */


        /* Adjusted padding for mobile header */
        @media (max-width: 768px) {
            .header {
                 margin: -20px -20px 20px -20px;
                 padding: 15px 15px;
            }
            
            /* MODIFIED: Header to show toggle button on the left */
            .header {
                justify-content: flex-start;
            }
            
            .header h1 {
                flex-grow: 1;
            }
            
            .header .actions {
                /* Push actions to the right - NOW HIDDEN */
                margin-left: auto; 
                flex-direction: row; 
                display: none; /* Hide actions in mobile header as they are in the drawer */
            }
        }
        /* End Header Adjustments */


        .header h1 {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 24px;
        }

        .header .actions {
            display: flex;
            gap: 10px;
        }

        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loader.active {
            display: flex;
        }

        .spinner {
            border: 4px solid var(--secondary-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #popup-message-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 10px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 999;
        }

        #popup-message-container.show {
            opacity: 1;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--text-light);
        }

        .btn-primary:hover {
            background-color: #4b2d0d;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #45a049;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #1e87e5;
        }

        .filter-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .filter-section input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding: 10px;
        }

        .order-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            border-left: 5px solid var(--primary-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .card-header h4 {
            color: var(--primary-color);
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .card-body p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .card-body strong {
            color: var(--accent-color);
        }

        .card-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-footer .status {
            font-weight: 700;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .card-footer .amount {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--success-color);
        }

        .status[data-status="Pending"],
        .status[data-status="Send"] {
            background-color: #ffe0b2;
            color: #ff9800;
        }

        .status[data-status="Completed"] {
            background-color: #c8e6c9;
            color: var(--success-color);
        }

        .status[data-status="Cancelled"] {
            background-color: #ffcdd2;
            color: var(--danger-color);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 90%;
            max-width: 600px;
            position: relative;
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .modal-content label {
            display: block;
            margin-top: 10px;
            font-weight: 600;
        }

        .modal-content input[type="text"],
        .modal-content input[type="number"],
        .modal-content input[type="date"],
        .modal-content select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 20px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: var(--danger-color);
            text-decoration: none;
        }

        .modal-actions {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        #login-modal .modal-content {
            max-width: 400px;
            text-align: left;
        }

        .new-order-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            min-height: 400px;
        }

        .menu-selection {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .order-summary {
            background: var(--secondary-color);
            padding: 15px;
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
        }

        .product-card {
            background: var(--card-bg);
            border: 1px solid var(--secondary-color);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
        }

        .product-card:hover {
            background-color: #f0f0f0;
        }
        
        .product-card h4 {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .product-card p {
            margin: 0;
            color: var(--accent-color);
            font-weight: 600;
        }

        .product-quantity-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--success-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .product-quantity-badge.visible {
            display: flex;
        }

        .current-order-list {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 5px;
        }

        .invoice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted #a0927f;
        }

        .invoice-item-info {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .invoice-item-info span:first-child {
            font-weight: 600;
        }

        .invoice-item-actions {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-btn, .remove-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }
        
        .remove-btn {
            background: var(--danger-color);
        }

        .quantity {
            min-width: 15px;
            text-align: center;
            font-weight: 600;
        }

        .new-order-total {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid var(--primary-color);
            font-size: 1.5em;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
        }

        #qr-scanner-modal .modal-content {
            max-width: 400px;
            text-align: center;
        }

        #qr-scanner-placeholder {
            width: 100%;
            height: 250px;
            background-color: #f0f0f0;
            border: 2px dashed var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.1em;
            color: var(--primary-color);
            margin-bottom: 15px;
            border-radius: var(--border-radius);
        }

        #attendance-history-modal .modal-content {
            max-width: 900px;
        }
        
        /* New style to ensure tables are scrollable on small screens */
        .responsive-table-wrap {
            overflow-x: auto;
            width: 100%;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .attendance-table th, .attendance-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 0.9em;
        }

        .attendance-table th {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .attendance-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Dashboard view styles */
        .dashboard-content {
            display: none; /* Hidden by default */
            padding: 20px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-top: 20px;
        }
        
        .dashboard-content.active {
            display: block; /* Shown when active */
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: var(--secondary-color);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .summary-card h4 {
            font-size: 1em;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .summary-card p {
            font-size: 2em;
            font-weight: 700;
            color: var(--accent-color);
        }
        
        .dashboard-link-card {
            background: var(--primary-color);
            color: var(--text-light);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .dashboard-link-card:hover {
            background-color: #4b2d0d;
        }
        .dashboard-link-card h4 {
            color: var(--text-light);
            margin: 0;
            font-size: 1.2em;
        }
        
        /* ADDED: New Footer Style */
        #attribution-footer {
            width: 100%;
            background-color: var(--primary-color);
            color: var(--secondary-color);
            text-align: center;
            padding: 10px 0;
            font-size: 0.8em;
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 90;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        #attribution-footer a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }

        #attribution-footer a:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }
        /* END ADDED Footer Style */

        @media (max-width: 768px) {
             body {
                flex-direction: column;
                position: relative; 
                overflow-x: hidden; /* Prevent horizontal scroll when drawer is off-screen */
            }
            
            .mobile-nav-toggle {
                display: block; /* Show the toggle button */
            }

            #sidebar {
                width: var(--sidebar-width); 
                height: 100vh;
                position: fixed; /* Fixed position for drawer */
                top: 0;
                left: 0;
                transform: translateX(-100%); /* Start off-screen */
                transition: transform 0.3s ease-in-out;
                z-index: 1000;
                box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
                overflow-y: auto;
            }

            #sidebar.open {
                transform: translateX(0); /* Slide in */
            }
            
            #sidebar h2 { display: block; margin-top: 20px; } /* Show title again */
            #sidebar ul { 
                display: block; /* Vertical list */
                justify-content: initial; 
            }
            
            #sidebar ul li { 
                margin-bottom: 5px; /* Restore vertical spacing */
            }
            
            #sidebar ul li a, #sidebar ul li button { 
                padding: 10px 15px; 
                font-size: 1em; 
                text-align: left; 
            }
            
            .container {
                /* Add padding on the left to accommodate the toggle button area */
                padding-left: 20px; 
            }
            
            /* MODIFIED: New Order Modal Mobile Fix */
            #new-order-modal .modal-content {
                max-width: 95%;
                margin: 10px auto;
                /* Removed height: 95vh; to improve fit and use max-height instead */
                max-height: 95vh; 
                overflow-y: auto;
            }

            #new-order-form > div:first-child {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            #new-order-form label {
                font-weight: 600;
                margin-top: 5px;
            }

            .new-order-grid {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            #new-order-menu-items {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .product-card {
                padding: 10px;
                margin: 0;
                font-size: 14px;
            }

            .product-card h4 {
                font-size: 14px;
            }

            .product-card p {
                font-size: 13px;
            }

            .product-quantity-badge {
                width: 18px;
                height: 18px;
                font-size: 11px;
            }

            .menu-selection { order: 1; }
            /* The input fields are outside the grid but their container is flex-col now, which is correct */
            .order-summary { order: 5; }

            .new-order-total {
                display: block;
            }
            
            /* MODIFIED: Ensure new-order-total is hidden when sticky bar is shown */
            .mobile-total-sticky {
                display: none;
            }

            .filter-section {
                flex-direction: column;
                gap: 10px;
            }
            
            .header .actions {
                flex-direction: row; 
                gap: 5px;
                align-items: center;
            }
            
            .header h1 {
                font-size: 20px;
                margin-left: 15px; /* Add space between toggle and title */
            }

            .new-order-grid {
                grid-template-columns: 1fr;
            }

            .menu-selection, .order-summary {
                max-height: none;
                height: auto;
            }

            .order-summary {
                order: -1;
            }

            .new-order-total {
                display: none;
            }

            .mobile-total-sticky {
                position: sticky;
                bottom: 0;
                left: 0;
                width: 100%;
                background: var(--primary-color);
                color: var(--text-light);
                padding: 10px;
                text-align: center;
                font-size: 1.5em;
                z-index: 10;
                display: block;
            }

            .modal-content {
                max-width: 95%;
                margin: 10px;
            }

	
            
            /* Ensures container content is above the fixed footer */
            .container {
                padding-bottom: 60px;
            }
        }
    </style>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
    <div id="loader" class="loader">
        <div class="spinner"></div>
    </div>

    <div id="popup-message-container"></div>
    
    <nav id="sidebar">
        <h2>Mapple's Cafe POS</h2>
        <ul>
            <li><a href="#" id="nav-dashboard" class="nav-link active">🏠 Dashboard</a></li>
            <li><a href="#" id="nav-today-orders" class="nav-link">☕ Today's Orders</a></li>
            <li><a href="#" id="nav-orders-log" class="nav-link">📜 All Orders</a></li>
            <li><button id="nav-viewAttendanceBtn" class="nav-link">📊 My Attendance</button></li>
            <li><button id="newOrderBtn" class="btn sidebar-action-button" style="margin-top: 20px;">New Order</button></li>
            <li><button id="scanQrBtn" class="btn sidebar-action-button" style="display: none;">Scan QR</button></li>
            <li><button id="logoutBtn" class="btn sidebar-action-button btn-danger" style="display: none;">Logout</button></li>
            </ul>
    </nav>
    
    <div class="sidebar-backdrop" id="sidebar-backdrop"></div>
    
    <div class="container">
        <div class="header">
            <button id="mobile-nav-toggle" class="mobile-nav-toggle">☰</button>
            <h1 id="main-header-title">Mapple's Cafe</h1>
            <div class="actions">
                </div>
        </div>
        
        <div id="dashboard-view" class="dashboard-content active">
            <h2>Welcome to Mapple's Cafe, <span id="employee-name-display">Employee</span>!</h2>
            
            <div class="summary-cards">
                <div class="summary-card">
                    <h4>My Total Orders (Today)</h4>
                    <p id="total-orders-today">0</p>
                </div>
                <div class="summary-card dashboard-link-card" id="card-attendance-link">
                    <h4>View My Attendance</h4>
                </div>
            </div>
            
            <h3 style="margin-top: 30px;">Quick Actions</h3>
            <div class="summary-cards">
                 <div class="summary-card dashboard-link-card" id="card-new-order">
                    <h4>Start New Order</h4>
                </div>
                <div class="summary-card dashboard-link-card" id="card-scan-qr">
                    <h4>Clock IN/OUT (Scan QR)</h4>
                </div>
                <div class="summary-card dashboard-link-card" id="card-all-orders">
                    <h4>Check All Orders</h4>
                </div>
            </div>
            
        </div>
        <div id="orders-log-view" class="dashboard-content">
            <h2>All My Orders</h2>
            <div class="filter-section">
                <input type="text" id="search-input" placeholder="Search Order ID, Table No..." style="flex-grow: 1;">
                <input type="date" id="date-input">
            </div>

            <div id="orders-card-container" class="card-container">
            </div>
        </div>
        <div id="today-orders-view" class="dashboard-content">
            <h2>My Orders Placed Today</h2>
            <div id="today-orders-card-container" class="card-container">
                <p style="text-align: center; margin-top: 50px;">Fetching today's orders...</p>
            </div>
        </div>
        </div>

    <div class="modals-container">
        <div id="login-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 400px;">
                <h3>Employee Login</h3>
                <form id="login-form">
                    <label for="login-emp-id">Employee ID (EmpId):</label>
                    <input type="text" id="login-emp-id" required>
                    
                    <label for="login-dob">Date of Birth (DOB):</label>
                    <input type="date" id="login-dob" required>
                    
                    <div class="modal-actions" style="padding-top: 10px; justify-content: center;">
                        <button type="submit" class="btn btn-primary">Login</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="new-order-modal" class="modal">
            <div class="modal-content" style="max-width: 1000px;">
                <span class="close-btn">&times;</span>
                <h3>Place New Order</h3>
                <form id="new-order-form">
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="flex-grow: 1;">
                            <label for="emp-id">Employee ID</label>
                            <input type="text" id="emp-id" required readonly>
                        </div>
                        <div style="flex-grow: 1;">
                            <label for="table-no">Table No</label>
                            <input type="text" id="table-no" placeholder="Table Number" required>
                        </div>
                        <div style="flex-grow: 1;">
                            <label for="customer-name">Customer Name</label>
                            <input type="text" id="customer-name" placeholder="Customer Name (Optional)">
                        </div>
                    </div>
                    
                    <div class="new-order-grid">
                        <div class="menu-selection">
                            <h4>Menu Items</h4>
                            <div id="new-order-menu-items"></div>
                        </div>
                        
                        <div class="order-summary">
                            <h4>Current Order</h4>
                            <div id="current-order-list" class="current-order-list"></div>
                            <div class="new-order-total-container">
                                <div class="new-order-total">
                                    <span>Total:</span>
                                    <span>₹<span id="new-order-total">0.00</span></span>
                                </div>
                            </div>
                            <div class="modal-actions">
                                <button type="button" class="btn btn-danger" id="new-order-cancel-btn">Cancel</button>
                                <button type="submit" class="btn btn-success" id="place-order-btn">Place Order</button>
                            </div>
                        </div>
                    </div>
                </form>
                <div class="mobile-total-sticky">
                    Total: ₹<span id="new-order-total-mobile">0.00</span>
                </div>
            </div>
        </div>

        <div id="order-details-modal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <span class="close-btn">&times;</span>
                <h3>Order Details</h3>
                <p><strong>Order ID:</strong> <span id="details-order-id"></span></p>
                <p><strong>Table No:</strong> <span id="details-table-no"></span></p>
                <p><strong>Customer:</strong> <span id="details-customer-name"></span></p>
                <p><strong>Status:</strong> <span id="details-order-status"></span></p>
                <hr>
                <h4>Items:</h4>
                <ul id="details-order-items" class="details-list"></ul>
                <hr>
                <p style="font-size: 1.2em;"><strong>Total Amount:</strong> ₹<span id="details-total-amount"></span></p>
                
                <div class="modal-actions">
                    <button class="btn btn-danger" id="cancel-order-btn">Cancel Order</button>
                    <button class="btn btn-info" id="edit-order-btn">Edit Order</button>
                </div>
            </div>
        </div>

        <div id="invoice-modal" class="modal">
            <div class="modal-content" style="max-width: 500px; text-align: center;">
                <span class="close-btn">&times;</span>
                <h3>Finalise Payment for Order <span id="invoice-order-id"></span></h3>
                <p style="font-size: 1.5em; font-weight: 700; color: var(--accent-color);">
                    Total: ₹<span id="invoice-total-amount">0.00</span>
                </p>
                
                <h4>Select Payment Method:</h4>
                <div class="payment-methods">
                    <button data-method="Cash" id="pay-cash-btn">Cash</button>
                    <button data-method="Online" id="pay-online-btn">Online/UPI</button>
                    <button data-method="Split" id="pay-split-btn">Split</button>
                </div>

                <div id="split-payment-section">
                    <div class="split-row">
                        <label for="cash-split-amount">Cash Amount:</label>
                        <input type="number" id="cash-split-amount" step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="split-row">
                        <label for="online-split-amount">Online Amount:</label>
                        <input type="number" id="online-split-amount" step="0.01" min="0" readonly placeholder="0.00">
                    </div>
                    <p style="margin-top: 5px;">Remaining (Error Check): <span class="remaining-amount">₹<span id="split-remaining">0.00</span></span></p>
                </div>

                <div class="modal-actions" style="justify-content: center;">
                    <button class="btn btn-success" id="finalise-payment-btn" disabled>Finalise Payment</button>
                </div>
            </div>
        </div>
        
        <div id="qr-scanner-modal" class="modal">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <span class="close-btn">&times;</span>
                <h3>Scan Attendance QR Code</h3>
                <div id="qr-scanner-placeholder">
                    [Camera Feed Placeholder]<br> (Requires external library like Instascan)
                </div>
                <p>Scanning for QR code generated by the system.</p>
                </div>
        </div>
        
        <div id="attendance-history-modal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <span class="close-btn">&times;</span>
                <h3>My Attendance History (Employee: <span id="attendance-emp-id-span"></span>)</h3>
                <div class="responsive-table-wrap">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Emp ID</th>
                                <th>Emp Name</th>
                                <th>IN Time</th>
                                <th>OUT Time</th>
                                <th>Total Duration (HH:MM:SS)</th> </tr>
                        </thead>
                        <tbody id="attendance-history-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <footer id="attribution-footer">
        <p>
            Designed by 
            <a href="https://www.mjsmartapps.xyz" target="_blank" rel="noopener noreferrer">MJ SMART APPS</a>
        </p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const popupMessageContainer = document.getElementById('popup-message-container');
            const loader = document.getElementById('loader');

            const loginModal = document.getElementById('login-modal');
            const loginForm = document.getElementById('login-form');
            const loginEmpIdInput = document.getElementById('login-emp-id');
            const loginDobInput = document.getElementById('login-dob'); 

            // REMAPPED to sidebar
            const newOrderBtn = document.getElementById('newOrderBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const scanQrBtn = document.getElementById('scanQrBtn');
            
            // Re-map View Attendance button from header to sidebar
            const viewAttendanceBtn = document.getElementById('nav-viewAttendanceBtn');
            
            const qrScannerModal = document.getElementById('qr-scanner-modal');
            const attendanceHistoryModal = document.getElementById('attendance-history-modal');
            const attendanceHistoryBody = document.getElementById('attendance-history-body');
            const attendanceEmpIdSpan = document.getElementById('attendance-emp-id-span');

            const ordersCardContainer = document.getElementById('orders-card-container');
            const todayOrdersCardContainer = document.getElementById('today-orders-card-container'); // NEW
            const newOrderModal = document.getElementById('new-order-modal');
            const empIdInput = document.getElementById('emp-id'); 

            const searchInput = document.getElementById('search-input');
            const dateInput = document.getElementById('date-input');
            
            // NEW: View elements
            const views = {
                'dashboard': document.getElementById('dashboard-view'),
                'orders-log': document.getElementById('orders-log-view'),
                'today-orders': document.getElementById('today-orders-view')
            };
            const navLinks = document.querySelectorAll('.nav-link');
            const mainHeaderTitle = document.getElementById('main-header-title');
            const employeeNameDisplay = document.getElementById('employee-name-display'); // NEW
            
            // --- ADDED: Mobile Drawer Elements ---
            const mobileNavToggle = document.getElementById('mobile-nav-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarBackdrop = document.getElementById('sidebar-backdrop');
            // -------------------------------------

            let currentOrderToComplete = null;
            let totalOrderAmount = 0;
            let loggedInEmpId = null; 
            let loggedInEmpName = null; // NEW

            const showLoader = () => { loader.classList.add('active'); };
            const hideLoader = () => { setTimeout(() => { loader.classList.remove('active'); }, 500); };

            const firebaseConfig = {
                apiKey: "AIzaSyABDWSr0M_A9sVw351QLm_MMfUDnLzW5Ik",
                authDomain: "mapples-8da36.firebaseapp.com",
                databaseURL: "https://mapples-8da36-default-rtdb.firebaseio.com",
                projectId: "mapples-8da36",
                storageBucket: "mapples-8da36.appspot.com",
                messagingSenderId: "673045371502",
                appId: "1:673045371502:web:095d625ab71b1fc7ada47f",
                measurementId: "G-Q9Q5YZD7J3"
            };

            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();

            let products = [];
            let orders = [];
            let employees = []; 
            let attendanceRecords = [];
            let currentOrder = [];
            let currentOrderId = null;

            const showPopupMessage = (message) => {
                popupMessageContainer.textContent = message;
                popupMessageContainer.classList.add('show');
                setTimeout(() => {
                    popupMessageContainer.classList.remove('show');
                }, 3000);
            };
            
            // --- ADDED: Drawer Toggle Function ---
            const toggleDrawer = () => {
                const isMobile = window.matchMedia("(max-width: 768px)").matches;
                if (!isMobile) return; 

                sidebar.classList.toggle('open');
                sidebarBackdrop.classList.toggle('visible');
                // Lock body scroll when drawer is open
                document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : 'auto';
            };
            
            // --- ADDED: Drawer Event Listeners ---
            mobileNavToggle.addEventListener('click', toggleDrawer);

            if (sidebarBackdrop) {
                sidebarBackdrop.addEventListener('click', toggleDrawer);
            }
            // -------------------------------------

            // NEW: Function to switch views
            const switchView = (viewId, title) => {
                // Deactivate all views and links
                Object.values(views).forEach(view => view.classList.remove('active'));
                navLinks.forEach(link => link.classList.remove('active'));
                
                // Activate selected view and link
                if (views[viewId]) {
                    views[viewId].classList.add('active');
                    mainHeaderTitle.textContent = title;
                    const navLink = document.getElementById(`nav-${viewId}`);
                    if (navLink) navLink.classList.add('active');
                }
                
                // Close drawer if open (mobile only)
                if (sidebar.classList.contains('open')) {
                    toggleDrawer(); 
                }
                
                // Specific logic for views
                if (viewId === 'orders-log') {
                    // Re-render Orders Log (original card container logic)
                    renderOrderCards(searchInput.value, dateInput.value, ordersCardContainer, orders);
                } else if (viewId === 'today-orders') {
                    // Render Today's Orders
                    renderTodayOrders();
                } else if (viewId === 'dashboard') {
                    // Render Dashboard Summary
                    renderDashboardSummary();
                }
            };

            // NEW: Event listeners for sidebar navigation (Modified to use switchView which handles closing the drawer)
            document.getElementById('nav-dashboard').addEventListener('click', (e) => {
                e.preventDefault();
                // RENAMED Dashboard title here
                switchView('dashboard', 'Mapple\'s Cafe');
            });
            document.getElementById('nav-today-orders').addEventListener('click', (e) => {
                e.preventDefault();
                switchView('today-orders', "My Today's Orders");
            });
            document.getElementById('nav-orders-log').addEventListener('click', (e) => {
                e.preventDefault();
                switchView('orders-log', 'All My Orders Log');
            });
            
            // NEW: Event listeners for Dashboard Quick Actions
            document.getElementById('card-new-order').addEventListener('click', () => newOrderBtn.click());
            document.getElementById('card-scan-qr').addEventListener('click', () => scanQrBtn.click());
            document.getElementById('card-all-orders').addEventListener('click', () => switchView('orders-log', 'All My Orders Log'));
            document.getElementById('card-attendance-link').addEventListener('click', () => viewAttendanceBtn.click());

            // NEW: Render Dashboard Summary (Employee-Only)
            const renderDashboardSummary = () => {
                const today = new Date().toISOString().split('T')[0];
                const todayOrdersCount = orders.filter(order => {
                    const orderDate = new Date(order.timestamp).toISOString().split('T')[0];
                    return orderDate === today && order.empId === loggedInEmpId;
                }).length;
                
                document.getElementById('total-orders-today').textContent = todayOrdersCount;
                employeeNameDisplay.textContent = loggedInEmpName || 'Employee';
            };
            
            // NEW: Render Today's Orders
            const renderTodayOrders = () => {
                const today = new Date().toISOString().split('T')[0];
                const todayOrders = orders.filter(order => {
                    const orderDate = new Date(order.timestamp).toISOString().split('T')[0];
                    return orderDate === today && order.empId === loggedInEmpId;
                });
                
                // Reuse renderOrderCards logic on the correct container, without search/date filter
                renderOrderCards('', '', todayOrdersCardContainer, todayOrders);
            };

            const updateUIForLoginStatus = (isLoggedIn) => {
                // Moved visibility control to sidebar buttons
                newOrderBtn.style.display = isLoggedIn ? 'block' : 'none'; // Block for sidebar buttons
                logoutBtn.style.display = isLoggedIn ? 'block' : 'none';
                scanQrBtn.style.display = isLoggedIn ? 'block' : 'none';
                
                // Hide view attendance button if logged out
                viewAttendanceBtn.style.display = isLoggedIn ? 'block' : 'none';

                if (!isLoggedIn) {
                    ordersCardContainer.innerHTML = '';
                    todayOrdersCardContainer.innerHTML = '';
                    document.getElementById('dashboard-view').classList.remove('active');
                    loginModal.style.display = 'flex';
                }
                
                // Show default view upon login status change
                if (isLoggedIn) {
                    // RENAMED Dashboard title here
                    switchView('dashboard', 'Mapple\'s Cafe');
                }
            };

            const checkLoginStatus = () => {
                const storedEmpId = localStorage.getItem('mapples_empId');
                
                if (storedEmpId) {
                    const employee = employees.find(emp => emp.empId === storedEmpId);
                    if (employee) {
                        loggedInEmpId = storedEmpId;
                        loggedInEmpName = employee.name; // Set name on login
                        loginModal.style.display = 'none';
                        updateUIForLoginStatus(true);
                        return;
                    } else {
                        localStorage.removeItem('mapples_empId');
                    }
                }
                
                loggedInEmpId = null;
                loggedInEmpName = null;
                updateUIForLoginStatus(false);
            };

            const handleLogin = (e) => {
                e.preventDefault();
                const enteredEmpId = loginEmpIdInput.value.trim(); 
                const enteredDob = loginDobInput.value; 
                
                const validEmployee = employees.find(emp => 
                    emp.empId === enteredEmpId && emp.dob === enteredDob
                );

                if (validEmployee) {
                    loggedInEmpId = enteredEmpId;
                    loggedInEmpName = validEmployee.name; // Set name on login
                    localStorage.setItem('mapples_empId', loggedInEmpId); 
                    loginModal.style.display = 'none';
                    updateUIForLoginStatus(true);
                    showPopupMessage(`Welcome, Employee ${loggedInEmpName}!`);
                } else {
                    showPopupMessage('Invalid Employee ID or Date of Birth. Please try again.');
                }
            };

            const handleLogout = () => {
                localStorage.removeItem('mapples_empId');
                loggedInEmpId = null;
                loggedInEmpName = null;
                showPopupMessage('You have been logged out.');
                updateUIForLoginStatus(false);
                loginForm.reset(); 
            };
            
            loginForm.addEventListener('submit', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            
            let qrScannerInstance = null;

            scanQrBtn.addEventListener('click', () => {
                if (!loggedInEmpId) {
                    showPopupMessage('Please log in to scan attendance.');
                    loginModal.style.display = 'flex';
                    return;
                }
                
                // Close drawer before opening modal
                if (sidebar.classList.contains('open')) {
                    toggleDrawer(); 
                }
                
                qrScannerModal.style.display = 'flex';

                const placeholderId = 'qr-scanner-placeholder';
                if (!qrScannerInstance) {
                    try {
                        qrScannerInstance = new Html5Qrcode(placeholderId);
                    } catch (err) {
                        console.error('Failed to create Html5Qrcode instance', err);
                        showPopupMessage('QR Scanner not supported in this browser.');
                        return;
                    }
                }

                const qrStartConfig = { fps: 10, qrbox: Math.min(250, Math.floor(window.innerWidth * 0.9)) };

                qrScannerInstance.start(
                    { facingMode: 'environment' },
                    qrStartConfig,
                    (decodedText) => {
                        qrScannerInstance.stop().then(() => {
                            qrScannerModal.style.display = 'none';
                            processAttendanceScan(decodedText);
                        }).catch((stopErr) => {
                            console.warn('Failed to stop scanner after scan:', stopErr);
                            qrScannerModal.style.display = 'none';
                            processAttendanceScan(decodedText);
                        });
                    },
                    (errorMessage) => {}
                ).catch(err => {
                    console.error('Unable to start QR scanner:', err);
                    showPopupMessage('Camera access failed. Please check permissions.');
                });
            });
            
            viewAttendanceBtn.addEventListener('click', () => {
                if (!loggedInEmpId) {
                    showPopupMessage('Please log in to view attendance.');
                    return;
                }
                // Close drawer before showing modal if on mobile
                if (sidebar.classList.contains('open')) {
                    toggleDrawer(); 
                }
                renderAttendanceHistory();
                attendanceHistoryModal.style.display = 'flex';
            });
            
            /**
             * Calculates the difference between two ISO 8601 strings and returns it in HH:MM:SS format.
             * @param {string} inTimeISO - The ISO string for clock IN.
             * @param {string} outTimeISO - The ISO string for clock OUT.
             * @returns {string} Total duration in HH:MM:SS format.
             */
            const calculateTotalDurationISO = (inTimeISO, outTimeISO) => {
                const inTimeMs = new Date(inTimeISO).getTime();
                const outTimeMs = new Date(outTimeISO).getTime();
                
                // Difference in milliseconds
                let diffMs = outTimeMs - inTimeMs;
                
                // Convert to hours, minutes, and seconds
                const diffSeconds = Math.floor(diffMs / 1000);
                const hours = Math.floor(diffSeconds / 3600);
                const minutes = Math.floor((diffSeconds % 3600) / 60);
                const seconds = diffSeconds % 60;

                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            };
            
            // --- UPDATED renderAttendanceHistory FUNCTION ---
            const renderAttendanceHistory = () => {
                attendanceHistoryBody.innerHTML = '';
                attendanceEmpIdSpan.textContent = loggedInEmpId;
                
                // Filter by the key 'employeeEmpId' to match the new storage structure
                const employeeAttendance = attendanceRecords.filter(rec => rec.employeeEmpId === loggedInEmpId)
                                                          .sort((a, b) => new Date(b.inTime) - new Date(a.inTime)); // Sort by most recent clock in

                if (employeeAttendance.length === 0) {
                    attendanceHistoryBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No attendance records found.</td></tr>';
                    return;
                }

                employeeAttendance.forEach(rec => {
                    // Total duration is stored directly on the record
                    const totalDuration = rec.totalDuration || 'N/A';
                    
                    // Convert ISO strings back to local time strings for display
                    const inTimeDate = rec.inTime ? new Date(rec.inTime) : null;
                    const outTimeDate = rec.outTime ? new Date(rec.outTime) : null;
                    
                    // Use a more readable time format for display
                    const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                    const inTimeDisplay = inTimeDate ? inTimeDate.toLocaleTimeString('en-US', timeOptions) : '---';
                    const outTimeDisplay = outTimeDate ? outTimeDate.toLocaleTimeString('en-US', timeOptions) : '---';
                    
                    const row = attendanceHistoryBody.insertRow();
                    row.innerHTML = `
                        <td>${rec.date}</td>
                        <td>${rec.employeeEmpId}</td>
                        <td>${rec.employeeName}</td>
                        <td>${inTimeDisplay}</td>
                        <td>${outTimeDisplay}</td>
                        <td>${totalDuration}</td>
                    `;
                });
            };

            // --- UPDATED processAttendanceScan FUNCTION (Uses calculateTotalDurationISO) ---
            const processAttendanceScan = async (scannedId) => {
                qrScannerModal.style.display = 'none';
                showLoader();
                
                const empId = loggedInEmpId;
                const employee = employees.find(e => e.empId === empId);
                const empName = employee ? employee.name : 'N/A';

                if (!employee) {
                    hideLoader();
                    showPopupMessage('Employee data not found.');
                    return;
                }

                // Get the full ISO timestamp for this event
                const currentTime = new Date();
                const inTime = currentTime.toISOString(); 
                const timeString = currentTime.toLocaleTimeString('en-US', { hour12: false });
                
                // Determine the date part from the QR ID (YYYY-MM-DD)
                const datePart = scannedId.split('-').slice(0, 3).join('-'); 
                
                // Reference the 'attendance' root for push functionality
                const attendanceRef = database.ref(`attendance`);
                
                try {
                    // 1. Check for the most recent **open** "IN" record for this employee on this date
                    // Use the date part in the query for robustness
                    const snapshot = await attendanceRef
                        .orderByChild('employeeEmpId')
                        .equalTo(empId)
                        .once('value');
                        
                    let lastRecord = null;
                    snapshot.forEach(child => {
                        const record = { key: child.key, ...child.val() };
                        // Filter records manually by date and check for open outTime
                        if (record.date === datePart && record.inTime && !record.outTime) {
                             lastRecord = record;
                        }
                    });

                    if (lastRecord) {
                        // 2. Clock OUT: Update the last open record
                        const totalDuration = calculateTotalDurationISO(lastRecord.inTime, inTime);

                        await attendanceRef.child(lastRecord.key).update({
                            outTime: inTime, // Use ISO format for outTime
                            totalDuration: totalDuration // UPDATED FIELD NAME
                        });

                        showPopupMessage(`Clock OUT successful at ${timeString}. Total Duration: ${totalDuration}`);

                    } else {
                        // 3. Clock IN: Create a new record
                        const newAttendanceRef = attendanceRef.push();
                        
                        await newAttendanceRef.set({
                            id: newAttendanceRef.key,
                            attendanceId: scannedId,
                            date: datePart,
                            employeeId: empId, 
                            employeeName: empName,
                            employeeEmpId: empId, 
                            inTime: inTime, // Full ISO timestamp
                            outTime: null,
                            totalDuration: null, // UPDATED FIELD NAME
                            generatedBy: 'System'
                        });

                        showPopupMessage(`Clock IN successful at ${timeString}!`);
                    }

                } catch (error) {
                    console.error("Error processing attendance:", error);
                    showPopupMessage('Failed to process attendance. Please try again.');
                } finally {
                    hideLoader();
                }
            };

            const generateOrderId = async () => {
                const today = new Date();
                const dd = String(today.getDate()).padStart(2, '0');
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const todayKey = `${dd}${mm}`;

                const counterRef = database.ref(`dailyOrderCounters/${todayKey}`);
                let counter = 0;
                await counterRef.transaction((currentValue) => {
                    return (currentValue || 0) + 1;
                }, (error, committed, snapshot) => {
                    if (error) {
                        console.error("Order counter transaction failed: ", error);
                    } else if (committed) {
                        counter = snapshot.val();
                    }
                });
                const nnn = String(counter).padStart(3, '0');
                return `${todayKey}${nnn}`;
            };

            document.querySelectorAll('.modal .close-btn, #new-order-cancel-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.closest('.modal');
                    if(modal.id !== 'login-modal') {
                        modal.style.display = 'none';
                    }
                    if (modal && modal.id === 'qr-scanner-modal' && typeof qrScannerInstance !== 'undefined' && qrScannerInstance) {
                        qrScannerInstance.stop().catch(() => {});
                    }
                });
            });

            newOrderBtn.addEventListener('click', () => {
                if (!loggedInEmpId) {
                    showPopupMessage('Please log in first using your Employee ID.');
                    loginModal.style.display = 'flex';
                    return;
                }
                
                // Close drawer before opening modal
                if (sidebar.classList.contains('open')) {
                    toggleDrawer(); 
                }
                
                empIdInput.value = loggedInEmpId;
                
                document.getElementById('table-no').value = '';
                document.getElementById('customer-name').value = '';
                currentOrder = [];
                currentOrderId = null;
                document.getElementById('place-order-btn').textContent = 'Place Order';
                renderNewOrderMenuItems();
                renderCurrentOrderList();
                renderNewOrderTotal();
                newOrderModal.style.display = 'flex';
            });

            // UPDATED: renderOrderCards now takes a container and optional orders array
            const renderOrderCards = (searchText = '', filterDate = '', containerElement = ordersCardContainer, ordersList = orders) => { 
                containerElement.innerHTML = ''; 

                if (!loggedInEmpId) {
                    containerElement.innerHTML = '<p style="text-align: center; margin-top: 50px;">Please log in to view your orders.</p>';
                    return;
                }
                
                const filteredOrders = ordersList.filter(order => {
                    const matchesEmployee = order.empId === loggedInEmpId;
                    if (!matchesEmployee) return false;

                    const searchLower = searchText.toLowerCase();
                    const orderDate = new Date(order.timestamp).toISOString().split('T')[0];
                    const matchesSearch = searchText === '' ||
                        (order.displayId && order.displayId.toLowerCase().includes(searchLower)) ||
                        (order.empId && order.empId.toLowerCase().includes(searchLower)) ||
                        (order.empName && order.empName.toLowerCase().includes(searchLower)) ||
                        (order.customerName && order.customerName.toLowerCase().includes(searchLower)) ||
                        (order.tableNo && order.tableNo.toLowerCase().includes(searchLower));

                    const matchesDate = filterDate === '' || orderDate === filterDate;
                    
                    // For the 'All Orders Log' view, apply search and date filters
                    if (containerElement === ordersCardContainer) {
                        return matchesSearch && matchesDate;
                    }
                    
                    return true; 
                });

                filteredOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                if (filteredOrders.length === 0) {
                     containerElement.innerHTML = '<p style="text-align: center; margin-top: 50px;">No orders found matching the criteria for Employee ' + loggedInEmpId + '.</p>';
                     return;
                }

                filteredOrders.forEach(order => {
                    const orderTime = new Date(order.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                    const card = document.createElement('div');
                    card.classList.add('order-card');
                    card.innerHTML = `
                        <div class="card-header">
                            <h4>Order: ${order.displayId || 'N/A'}</h4>
                            <p>${orderTime}</p>
                        </div>
                        <div class="card-body">
                            <p><strong>Table No:</strong> ${order.tableNo || 'N/A'}</p>
                            <p><strong>Customer:</strong> ${order.customerName || 'N/A'}</p>
                            <p><strong>Staff:</strong> ${order.empId || 'N/A'} (${order.empName || 'N/A'})</p>
                        </div>
                        <div class="card-footer">
                            <span class="amount">₹${order.totalAmount.toFixed(2)}</span>
                            <span class="status" data-status="${order.status}">${order.status}</span>
                            <button class="btn btn-info view-order-details-btn" data-id="${order.orderId}">View</button>
                        </div>
                    `;
                    containerElement.appendChild(card);
                });
            };
            
            // Centralized click handler for both order card containers
            document.querySelectorAll('.container').forEach(container => {
                container.addEventListener('click', (e) => { 
                    if (e.target.classList.contains('view-order-details-btn')) {
                        const id = e.target.dataset.id;
                        const order = orders.find(o => o.orderId === id);
                        if (order && order.empId === loggedInEmpId) {
                            const orderDetailsModal = document.getElementById('order-details-modal');
                            document.getElementById('details-order-id').textContent = order.displayId || 'N/A';
                            document.getElementById('details-table-no').textContent = order.tableNo;
                            document.getElementById('details-customer-name').textContent = order.customerName || 'N/A';
                            document.getElementById('details-total-amount').textContent = order.totalAmount.toFixed(2);
                            document.getElementById('details-order-status').textContent = order.status;
                            const itemsList = document.getElementById('details-order-items');
                            itemsList.innerHTML = '';
                            order.items.forEach(item => {
                                const itemTotal = item.total || (item.price * item.quantity);
                                const li = document.createElement('li');
                                li.innerHTML = `<span>${item.name} x${item.quantity}</span><span>₹${itemTotal.toFixed(2)}</span>`;
                                itemsList.appendChild(li);
                            });

                            const cancelBtn = document.getElementById('cancel-order-btn');
                            const editBtn = document.getElementById('edit-order-btn');
                            
                            const isPendingOrSend = order.status === 'Pending' || order.status === 'Send';
                            cancelBtn.style.display = isPendingOrSend ? 'inline-block' : 'none';
                            editBtn.style.display = isPendingOrSend ? 'inline-block' : 'none';
                            
                            editBtn.onclick = () => {
                                currentOrderId = order.orderId;
                                currentOrder = order.items.map(item => ({...item, total: undefined}));
                                document.getElementById('emp-id').value = order.empId;
                                document.getElementById('table-no').value = order.tableNo;
                                document.getElementById('customer-name').value = order.customerName;
                                document.getElementById('place-order-btn').textContent = 'Update Order';
                                renderNewOrderMenuItems();
                                renderCurrentOrderList();
                                renderNewOrderTotal();
                                orderDetailsModal.style.display = 'none';
                                newOrderModal.style.display = 'flex';

                                currentOrder.forEach(item => {
                                    const quantityBadge = document.getElementById(`qty-card-${item.id}`);
                                    if (quantityBadge) {
                                        quantityBadge.textContent = item.quantity;
                                        quantityBadge.classList.add('visible');
                                    }
                                });
                            };

                            cancelBtn.onclick = async () => {
                                await database.ref('orders/' + id).update({ status: 'Cancelled' });
                                showPopupMessage('Order cancelled.');
                                orderDetailsModal.style.display = 'none';
                            };
                            orderDetailsModal.style.display = 'flex';
                        } else if (order) {
                            showPopupMessage('You do not have permission to view details for this order.');
                        }
                    }
                });
            });


            const renderNewOrderMenuItems = () => { 
                const newOrderMenuItems = document.getElementById('new-order-menu-items');
                newOrderMenuItems.innerHTML = '';
                products.forEach(product => {
                    const card = document.createElement('div');
                    card.classList.add('product-card');
                    card.dataset.id = product.id;
                    
                    const currentQty = (currentOrder.find(item => item.id === product.id)?.quantity || 0);

                    card.innerHTML = `
                        <h4>${product.name}</h4>
                        <p>₹${product.price.toFixed(2)}</p>
                        <span class="product-quantity-badge ${currentQty > 0 ? 'visible' : ''}" 
                              id="qty-card-${product.id}">${currentQty}</span>
                    `;
                    newOrderMenuItems.appendChild(card);
                });
            };

            const renderCurrentOrderList = () => { 
                const currentOrderList = document.getElementById('current-order-list');
                const newOrderModal = document.getElementById('new-order-modal');
                currentOrderList.innerHTML = '';
                currentOrder.forEach(item => {
                    const listItem = document.createElement('div');
                    listItem.classList.add('invoice-item');
                    listItem.dataset.id = item.id;
                    listItem.innerHTML = `
                        <div class="invoice-item-info">
                            <span>${item.name}</span>
                            <span>₹${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                        <div class="invoice-item-actions">
                            <button type="button" class="quantity-btn decrease-quantity-btn" data-id="${item.id}">-</button>
                            <span class="quantity">${item.quantity}</span>
                            <button type="button" class="quantity-btn increase-quantity-btn" data-id="${item.id}">+</button>
                            <button type="button" class="remove-btn" data-id="${item.id}">&times;</button>
                        </div>
                    `;
                    currentOrderList.appendChild(listItem);
                });

                newOrderModal.querySelectorAll('.increase-quantity-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const itemId = event.target.dataset.id;
                        const itemToUpdate = currentOrder.find(item => item.id === itemId);
                        if (itemToUpdate) {
                            itemToUpdate.quantity++;
                            renderCurrentOrderList();
                            renderNewOrderTotal();
                            const quantityBadge = document.getElementById(`qty-card-${itemId}`);
                            if (quantityBadge) {
                                quantityBadge.textContent = itemToUpdate.quantity;
                                quantityBadge.classList.add('visible');
                            }
                        }
                    });
                });

                newOrderModal.querySelectorAll('.decrease-quantity-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const itemId = event.target.dataset.id;
                        const itemToUpdate = currentOrder.find(item => item.id === itemId);
                        if (itemToUpdate && itemToUpdate.quantity > 1) {
                            itemToUpdate.quantity--;
                            renderCurrentOrderList();
                            renderNewOrderTotal();
                            const quantityBadge = document.getElementById(`qty-card-${itemId}`);
                            if (quantityBadge) {
                                quantityBadge.textContent = itemToUpdate.quantity;
                            }
                        } else if (itemToUpdate && itemToUpdate.quantity === 1) {
                            const itemIndex = currentOrder.findIndex(item => item.id === itemId);
                            currentOrder.splice(itemIndex, 1);
                            renderCurrentOrderList();
                            renderNewOrderTotal();
                            const quantityBadge = document.getElementById(`qty-card-${itemId}`);
                            if (quantityBadge) {
                                quantityBadge.textContent = '0';
                                quantityBadge.classList.remove('visible');
                            }
                        }
                    });
                });

                newOrderModal.querySelectorAll('.remove-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const itemId = event.target.dataset.id;
                        const itemIndex = currentOrder.findIndex(item => item.id === itemId);
                        if (itemIndex > -1) {
                            currentOrder.splice(itemIndex, 1);
                            renderCurrentOrderList();
                            renderNewOrderTotal();
                            const quantityBadge = document.getElementById(`qty-card-${itemId}`);
                            if (quantityBadge) {
                                quantityBadge.textContent = '0';
                                quantityBadge.classList.remove('visible');
                            }
                        }
                    });
                });
            };

            const renderNewOrderTotal = () => { 
                const newOrderTotalSpan = document.getElementById('new-order-total');
                const newOrderTotalMobileSpan = document.getElementById('new-order-total-mobile');
                const total = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const totalString = total.toFixed(2);
                newOrderTotalSpan.textContent = totalString;
                newOrderTotalMobileSpan.textContent = totalString;
            };

            const newOrderMenuItems = document.getElementById('new-order-menu-items');
            newOrderMenuItems.addEventListener('click', (e) => { 
                const card = e.target.closest('.product-card');
                if (!card) return;

                const id = card.dataset.id;
                const product = products.find(p => p.id === id);
                if (!product) return;

                let existingItem = currentOrder.find(item => item.id === id);

                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    existingItem = { ...product, quantity: 1 };
                    currentOrder.push(existingItem);
                }

                const quantityBadge = document.getElementById(`qty-card-${id}`);
                if (quantityBadge) {
                    quantityBadge.textContent = existingItem.quantity;
                    quantityBadge.classList.add('visible');
                }

                renderCurrentOrderList();
                renderNewOrderTotal();
            });

            const newOrderForm = document.getElementById('new-order-form');
            newOrderForm.addEventListener('submit', async (e) => { 
                e.preventDefault();
                showLoader();
                const empId = empIdInput.value; 
                const tableNo = document.getElementById('table-no').value.trim();
                const customerName = document.getElementById('customer-name').value;
                const totalAmount = parseFloat(document.getElementById('new-order-total').textContent);

                const employee = employees.find(emp => emp.empId === empId); 
                const empName = employee ? employee.name : 'N/A';

                if (!empId) {
                    hideLoader();
                    showPopupMessage('Employee ID is required!');
                    return;
                }
                
                if (!tableNo) {
                    hideLoader();
                    showPopupMessage('Table No is required!');
                    return;
                }

                if (currentOrder.length === 0) {
                    hideLoader();
                    showPopupMessage('Order cannot be empty!');
                    return;
                }

                try {
                    let orderRef;
                    let displayId;

                    if (currentOrderId) {
                        orderRef = database.ref('orders/' + currentOrderId);
                        const snapshot = await orderRef.once('value');
                        displayId = snapshot.val().displayId;
                    } else {
                        const newOrderIdKey = database.ref('orders').push().key;
                        orderRef = database.ref('orders/' + newOrderIdKey);
                        currentOrderId = newOrderIdKey;
                        displayId = await generateOrderId();
                    }


                    const orderData = {
                        orderId: currentOrderId,
                        displayId: displayId,
                        empId,
                        empName,
                        tableNo,
                        customerName,
                        items: currentOrder.map(item => ({...item, total: parseFloat((item.price * item.quantity).toFixed(2))})),
                        totalAmount: parseFloat(totalAmount.toFixed(2)),
                        status: currentOrderId ? 'Pending' : 'Pending',
                        timestamp: new Date().toISOString()
                    };

                    await orderRef.set(orderData);
                    showPopupMessage(currentOrderId ? 'Order updated successfully!' : 'Order placed successfully!');
                    newOrderModal.style.display = 'none';
                } catch (error) {
                    console.error("Error placing/updating order:", error);
                    showPopupMessage('Failed to place/update order.');
                } finally {
                    hideLoader();
                }
            });
            
            database.ref('products').on('value', (snapshot) => {
                products = [];
                snapshot.forEach(childSnapshot => {
                    products.push(childSnapshot.val());
                });
                renderNewOrderMenuItems();
            });

            database.ref('orders').on('value', (snapshot) => {
                orders = [];
                snapshot.forEach(childSnapshot => {
                    const order = childSnapshot.val();
                    orders.push(order);
                });
                
                // Re-render only the currently active view that depends on orders
                if (views['orders-log'].classList.contains('active')) {
                     renderOrderCards(searchInput.value, dateInput.value, ordersCardContainer);
                } else if (views['today-orders'].classList.contains('active')) {
                     renderTodayOrders();
                } else if (views['dashboard'].classList.contains('active')) {
                    renderDashboardSummary();
                }
            });
            
            database.ref('attendance').on('value', (snapshot) => {
                attendanceRecords = [];
                snapshot.forEach(childSnapshot => {
                    attendanceRecords.push(childSnapshot.val());
                });
            });

            database.ref('employees').on('value', (snapshot) => {
                employees = [];
                snapshot.forEach(childSnapshot => {
                    employees.push(childSnapshot.val());
                });
                
                checkLoginStatus(); 
                
                // Update dashboard summary if active
                if (views['dashboard'].classList.contains('active')) {
                     renderDashboardSummary();
                }
            });

            searchInput.addEventListener('input', () => {
                if (views['orders-log'].classList.contains('active')) {
                    renderOrderCards(searchInput.value, dateInput.value, ordersCardContainer);
                }
            });
            dateInput.addEventListener('change', () => {
                if (views['orders-log'].classList.contains('active')) {
                    renderOrderCards(searchInput.value, dateInput.value, ordersCardContainer);
                }
            });
        });
    </script>
</body>
</html>
